#!/usr/bin/env ruby19
# -*-ruby-*-

require 'rss/maker'
require 'date'
require 'json'
require 'jsonschema'

require_relative '../lib/bwkfanboy/utils'

$conf = {
  banner: "Usage: #{File.basename($0)} [options] < json",
  check: false
}

o = Bwkfanboy::Utils.cl_parse(ARGV, $conf[:banner])
o.on('--check', 'Validate the input (slow!)') { |i| $conf[:check] = true }
Bwkfanboy::Utils.cl_parse(ARGV, $conf[:banner], o) # run cl parser

begin
  j = JSON.parse(STDIN.read)
rescue
  Bwkfanboy::Utils.errx(1, "stdin had invalid JSON");
end

# validate the input
if $conf[:check] then
  begin
    schema = File.dirname(File.expand_path($0)) + '/../lib/bwkfanboy/schema.js'
    JSON::Schema.validate(j, JSON.parse(File.read(schema)))
  rescue
    Bwkfanboy::Utils.errx(1, "JSON validation failed");
  end
end

feed = RSS::Maker.make("atom") { |maker|
  maker.channel.id = j['channel']['id']
  maker.channel.updated = j['channel']['updated']
  maker.channel.author = j['channel']['author']
  maker.channel.title = j['channel']['title']
  maker.channel.link = j['channel']['link']

  maker.items.do_sort = true

  j['x_entries'].each { |i|
    maker.items.new_item do |item|
      item.link = i['link']
      item.title = i['title']
      item.updated = i['updated']
      item.content.type = j['channel']['x_entries_content_type']
      
      case item.content.type
      when 'text'
        item.content.content = i['content']
      when 'html'
        item.content.content = i['content']
      else
        item.content.xhtml = i['content']
      end
    end
  }
}

puts feed
